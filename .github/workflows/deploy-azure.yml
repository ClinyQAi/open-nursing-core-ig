name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Check Required Secrets
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "❌ Missing: AZURE_CLIENT_ID"
            echo "Please add this to GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then
            echo "❌ Missing: AZURE_CLIENT_SECRET"
            echo "Please add this to GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "❌ Missing: AZURE_TENANT_ID"
            echo "Please add this to GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "❌ Missing: AZURE_SUBSCRIPTION_ID"
            echo "Please add this to GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_OPENAI_ENDPOINT }}" ]; then
            echo "❌ Missing: AZURE_OPENAI_ENDPOINT"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_OPENAI_API_KEY }}" ]; then
            echo "❌ Missing: AZURE_OPENAI_API_KEY"
            exit 1
          fi
          echo "✓ All required secrets present"
      
      - name: Azure CLI Login
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          echo "Authenticating with Azure..."
          az login \
            --service-principal \
            -u "$AZURE_CLIENT_ID" \
            -p "$AZURE_CLIENT_SECRET" \
            --tenant "$AZURE_TENANT_ID"
          
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"
          echo "✓ Successfully logged in to Azure"
      
      - name: Build and push to Azure Container Registry
        run: |
          echo "Building Docker image..."
          az acr build \
            --registry nursingvalidatoracr \
            --image nursing-validator:latest \
            --image nursing-validator:${{ github.sha }} \
            --file Dockerfile .
          echo "✓ Image built and pushed"
      
      - name: Deploy to Azure Container Instances
        run: |
          echo "Deploying to Azure Container Instances..."
          
          # Get registry credentials
          REGISTRY_USERNAME=$(az acr credential show --name nursingvalidatoracr --query username --output tsv)
          REGISTRY_PASSWORD=$(az acr credential show --name nursingvalidatoracr --query 'passwords[0].value' --output tsv)
          
          # Delete existing container if it exists
          az container delete --resource-group nursing-validator-prod --name nursing-validator --yes 2>/dev/null || true
          sleep 5
          
          # Create new container
          az container create \
            --resource-group nursing-validator-prod \
            --name nursing-validator \
            --image nursingvalidatoracr.azurecr.io/nursing-validator:latest \
            --registry-login-server nursingvalidatoracr.azurecr.io \
            --registry-username "$REGISTRY_USERNAME" \
            --registry-password "$REGISTRY_PASSWORD" \
            --cpu 2 \
            --memory 4 \
            --ports 8501 \
            --environment-variables \
              APP_ENV=production \
              LOG_LEVEL=info \
            --secure-environment-variables \
              AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
              AZURE_OPENAI_API_KEY="${{ secrets.AZURE_OPENAI_API_KEY }}" \
              AZURE_OPENAI_DEPLOYMENT="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
              AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
            --restart-policy OnFailure
          
          echo "✓ Container deployed"
      
      - name: Get deployment URL
        run: |
          echo "Waiting for public IP..."
          sleep 10
          
          FQDN=$(az container show --resource-group nursing-validator-prod --name nursing-validator --query ipAddress.fqdn --output tsv)
          
          if [ -z "$FQDN" ]; then
            echo "⚠️  Public IP not yet assigned, check again in 30 seconds"
            echo "Run: az container show --resource-group nursing-validator-prod --name nursing-validator --query ipAddress.fqdn"
          else
            echo ""
            echo "✅ DEPLOYMENT COMPLETE!"
            echo ""
            echo "Access your application at:"
            echo "http://$FQDN:8501"
            echo ""
            echo "Login with:"
            echo "  Username: admin"
            echo "  Password: admin2025"
          fi
